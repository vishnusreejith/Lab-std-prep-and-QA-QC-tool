<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemCalc: Standards & Calibration</title>
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #64748b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --success: #22c55e;
            --danger: #ef4444;
            --warning-bg: #fff7ed;
            --warning-text: #c2410c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        header h1 { margin: 0; font-size: 1.5rem; }
        header p { margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem; }

        /* Report Controls */
        .report-controls {
            display: flex;
            gap: 15px;
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .meta-inputs {
            display: flex;
            flex: 1;
            gap: 10px;
            flex-wrap: wrap;
        }

        .meta-inputs input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 200px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: #f1f5f9;
            flex-wrap: wrap;
        }

        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            min-width: 140px;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #e2e8f0;
            color: var(--primary);
        }

        .nav-btn.active {
            color: var(--primary-dark);
            border-bottom-color: var(--primary);
            background: var(--surface);
        }

        /* Content Sections */
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-group input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            text-decoration: none;
        }

        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #475569; }

        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-add { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* Results Box */
        .result-panel {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            word-break: break-all;
        }

        .formula-note {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--secondary);
            font-style: italic;
        }

        /* Calibration Layout */
        .calib-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 25px;
        }
        
        /* Validation Layout */
        .validation-section {
            padding-bottom: 30px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }
        .validation-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section-title {
            font-size: 1.1rem;
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Data Table */
        .data-table-container {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 250px;
        }

        th {
            background: #f8fafc;
            padding: 10px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--secondary);
            text-align: left;
            white-space: nowrap;
        }

        td {
            padding: 8px;
            border-top: 1px solid var(--border);
        }

        td input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            min-width: 60px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
        }

        .stat-label { font-size: 0.8rem; color: var(--secondary); text-transform: uppercase; }
        .stat-val { font-size: 1.1rem; font-weight: 700; color: var(--text); margin-top: 5px; word-break: break-word; }
        .stat-val.highlight { color: var(--primary); }

        .chart-wrapper {
            margin-top: 25px;
            height: 300px;
            position: relative;
            width: 100%;
        }
        
        /* Tip Box */
        .tip-box {
            background-color: var(--warning-bg);
            border: 1px solid #fed7aa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--warning-text);
            font-size: 0.9rem;
        }
        
        details > summary {
            cursor: pointer;
            font-weight: 600;
            list-style: none;
            user-select: none;
        }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::after { content: "+"; float: right; font-weight: bold; }
        details[open] > summary::after { content: "-"; }
        
        .helper-text {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-top: 4px;
        }

        /* Print Header - Hidden on screen */
        #print-header { display: none; }

        /* Media Queries */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .calib-layout { grid-template-columns: 1fr; gap: 30px; }
            .tab-content { padding: 15px; }
            .nav-btn { padding: 12px 8px; font-size: 0.9rem; }
            h1 { font-size: 1.3rem; }
            .chart-wrapper { height: 250px; }
        }

        /* PRINT STYLES */
        @media print {
            body { background: white; padding: 0; color: black; }
            .container { 
                box-shadow: none; 
                border: none; 
                width: 100% !important; 
                max-width: none !important; 
                margin: 0; 
                padding: 0;
            }
            
            /* Hide UI elements */
            .nav-tabs, .btn, .tip-box, .report-controls, header { display: none !important; }
            
            /* Show Print Header */
            #print-header { 
                display: block !important; 
                margin-bottom: 20px; 
                border-bottom: 2px solid #000; 
                padding-bottom: 10px; 
            }

            /* Ensure content visibility */
            .tab-content.active { padding: 0; animation: none; }
            .input-grid, .calib-layout, .validation-section { display: block; }
            .input-grid { margin-bottom: 15px; }
            
            /* Make inputs look like text */
            input, textarea { 
                border: none !important; 
                background: none !important; 
                padding: 0 !important; 
                font-weight: bold;
                color: black !important;
                resize: none;
            }
            label { color: #666; font-size: 0.8rem; }
            
            /* Layout fixes */
            .calib-layout > div { margin-bottom: 20px; page-break-inside: avoid; }
            .chart-wrapper { height: 350px !important; border: 1px solid #ddd; page-break-inside: avoid; }
            .result-panel { border: 1px solid #ccc; background: none; }
            
            /* Force black text */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Print Header (Visible only on Print) -->
    <div id="print-header">
        <!-- Content injected by JS -->
    </div>

    <header>
        <h1>üß™ Lab Tools Suite</h1>
        <p>Standard Preparation & Method Validation</p>
    </header>

    <!-- Report Controls -->
    <div class="report-controls">
        <div class="meta-inputs">
            <input type="text" id="analystName" placeholder="Analyst Name">
            <input type="text" id="locationName" placeholder="Location" value="Thiruvananthapuram, Kerala, India">
        </div>
        <button class="btn btn-sm btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('prep')">Solution Prep</button>
        <button class="nav-btn" onclick="switchTab('calib')">Calibration & LOD/LOQ</button>
        <button class="nav-btn" onclick="switchTab('valid')">Validation (RSD & Rec)</button>
    </div>

    <!-- TAB 1: Solution Preparation -->
    <div id="prep" class="tab-content active">
        <div class="input-grid">
            <div class="form-group">
                <label>Target Conc. (mg/L)</label>
                <input type="number" id="conc" placeholder="e.g. 1000">
            </div>
            <div class="form-group">
                <label>Target Volume (mL)</label>
                <input type="number" id="vol" placeholder="e.g. 100">
            </div>
            <div class="form-group">
                <label>Source Purity (%)</label>
                <input type="number" id="purity" value="100" placeholder="e.g. 99.5">
            </div>
        </div>

        <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);">
            <div style="margin-bottom:15px; font-weight:600; color:var(--primary-dark); display:flex; justify-content:space-between; align-items:center;">
                <span>Atomic/MW Correction</span>
                <span style="font-size:0.8rem; color:var(--secondary); font-weight:normal;">Optional</span>
            </div>
            
            <div class="tip-box">
                <details>
                    <summary>üí° "Ions per Formula Unit"?</summary>
                    <div style="margin-top: 10px; line-height: 1.6;">
                        <p style="margin:5px 0;">This factor adjusts for the stoichiometry when your source chemical contains multiple atoms of the target ion.</p>
                        <ul style="padding-left: 20px; margin: 5px 0;">
                            <li><strong>Ex 1:</strong> Cl‚Åª from NaCl.<br>Value = <strong>1</strong> (1 Cl in NaCl)</li>
                            <li><strong>Ex 2:</strong> Cl‚Åª from CaCl‚ÇÇ.<br>Value = <strong>2</strong> (2 Cl in CaCl‚ÇÇ)</li>
                            <li><strong>Ex 3:</strong> Na‚Å∫ from Na‚ÇÇSO‚ÇÑ.<br>Value = <strong>2</strong> (2 Na in Na‚ÇÇSO‚ÇÑ)</li>
                        </ul>
                    </div>
                </details>
            </div>
            
            <div class="input-grid" style="margin-bottom: 0;">
                <div class="form-group">
                    <label>Source Chem Formula</label>
                    <input type="text" id="sourceFormula" placeholder="e.g. CaCl2" onblur="handleFormulaInput('source')">
                    <div class="helper-text">Auto-calculates MW</div>
                </div>
                <div class="form-group">
                    <label>Source MW (g/mol)</label>
                    <input type="number" id="sourceMW" placeholder="e.g. 110.98">
                </div>
            </div>
            
            <div class="input-grid" style="margin-bottom: 0; margin-top: 15px;">
                <div class="form-group">
                    <label>Target Formula</label>
                    <input type="text" id="targetFormula" placeholder="e.g. Cl" onblur="handleFormulaInput('target')">
                    <div class="helper-text">Auto-sets Stoichiometry</div>
                </div>
                <div class="form-group">
                    <label>Target MW (g/mol)</label>
                    <input type="number" id="targetMW" placeholder="e.g. 35.45">
                </div>
                <div class="form-group">
                    <label>Ions per Formula</label>
                    <input type="number" id="stoich" value="1" placeholder="e.g. 2">
                    <div class="helper-text">Check tip above</div>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" onclick="calculateWeight()">Calculate Mass Required</button>

        <div id="prep-results" class="result-panel" style="display: none;">
            <div style="text-align: center;">
                <div style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 5px;">Weigh exactly:</div>
                <div class="result-value" id="mass-display">0.0000 g</div>
                <div style="font-size: 1rem; color: var(--text); margin-top: 5px;" id="mass-mg-display">(0 mg)</div>
            </div>
            <div class="formula-note" id="calc-explanation">
                Calculation: Mass = (Conc √ó Vol) / Purity
            </div>
        </div>
    </div>

    <!-- TAB 2: Calibration -->
    <div id="calib" class="tab-content">
        <div class="calib-layout">
            
            <!-- Section 1: Data Entry -->
            <div>
                <h3 style="margin-top:0;">Data Points</h3>
                <div class="data-table-container">
                    <table id="calib-table">
                        <thead>
                            <tr>
                                <th>Conc (X)</th>
                                <th>Response (Y)</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="calib-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-add" onclick="addRow()">+ Point</button>
                    <button class="btn btn-sm btn-primary" style="flex:1;" onclick="processCalibration()">Calculate</button>
                </div>
            </div>

            <!-- Section 2: Results -->
            <div>
                <h3 style="margin-top:0;">Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Slope (m)</div>
                        <div class="stat-val" id="slope">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Intercept (b)</div>
                        <div class="stat-val" id="intercept">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">R¬≤</div>
                        <div class="stat-val" id="r2">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Res. SD (œÉ)</div>
                        <div class="stat-val" id="syx">-</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--primary);">
                        <div class="stat-label">LOD (3.3œÉ/m)</div>
                        <div class="stat-val highlight" id="lod">-</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--primary);">
                        <div class="stat-label">LOQ (10œÉ/m)</div>
                        <div class="stat-val highlight" id="loq">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-wrapper">
            <canvas id="calibChart"></canvas>
        </div>
        
        <div class="formula-note" style="margin-top: 15px;">
            <strong>Methodology:</strong> LOD/LOQ are calculated based on the Calibration Curve method (ICH Q2(R1)). 
            œÉ is the Standard Error of the Y-Estimate (Residual Standard Deviation).
        </div>
    </div>
    
    <!-- TAB 3: Validation (New) -->
    <div id="valid" class="tab-content">
        
        <!-- Precision Section -->
        <div class="validation-section">
            <h3 class="section-title">Precision (Repeatability / Interday)</h3>
            <p style="margin-top: -10px; margin-bottom: 15px; font-size: 0.9rem; color: var(--secondary);">Paste a list of measured values (e.g. from Excel) to calculate RSD.</p>
            
            <div class="input-grid">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Data Values (one per line)</label>
                    <textarea id="rsdData" placeholder="10.2&#10;10.1&#10;10.3&#10;..."></textarea>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="calculateRSD()">Calculate Precision Stats</button>
            
            <div class="stats-grid" style="margin-top: 15px;">
                <div class="stat-card">
                    <div class="stat-label">Count (n)</div>
                    <div class="stat-val" id="rsd-n">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mean</div>
                    <div class="stat-val" id="rsd-mean">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Std Dev (SD)</div>
                    <div class="stat-val" id="rsd-sd">-</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label">% RSD</div>
                    <div class="stat-val highlight" id="rsd-val">-</div>
                </div>
            </div>
        </div>

        <!-- Recovery Section -->
        <div class="validation-section">
            <h3 class="section-title">Recovery Study</h3>
            
            <div class="input-grid">
                <div class="form-group">
                    <label>Unspiked Conc. (C<sub>unspiked</sub>)</label>
                    <input type="number" id="concUnspiked" placeholder="e.g. 10.5">
                </div>
                <div class="form-group">
                    <label>Spiked Conc. (C<sub>spiked</sub>)</label>
                    <input type="number" id="concSpiked" placeholder="e.g. 20.8">
                </div>
                <div class="form-group">
                    <label>Added Conc. (C<sub>added</sub>)</label>
                    <input type="number" id="concAdded" placeholder="e.g. 10.0">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="calculateRecovery()">Calculate % Recovery</button>
            
            <div id="rec-results" class="result-panel" style="display: none; padding: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--secondary);">Recovery</div>
                    <div class="result-value" id="rec-display">-%</div>
                </div>
                <div class="formula-note">
                    Formula: (C<sub>spiked</sub> - C<sub>unspiked</sub>) / C<sub>added</sub> √ó 100
                </div>
            </div>
        </div>
        
    </div>

</div>

<script>
    // --- PRINT LOGIC ---
    function printReport() {
        const analyst = document.getElementById('analystName').value || "Not specified";
        const loc = document.getElementById('locationName').value;
        const time = new Date().toLocaleString();
        
        const headerHtml = `
            <div style="display:flex; justify-content:space-between; align-items:flex-end; font-family:sans-serif;">
                <div>
                    <h1 style="margin:0; font-size:1.8rem; color:#333;">Analytical Report</h1>
                    <p style="margin:5px 0 0 0; color:#666;">Generated: ${time}</p>
                </div>
                <div style="text-align:right; font-size:0.95rem;">
                    <p style="margin:0;"><strong>Analyst:</strong> ${analyst}</p>
                    <p style="margin:5px 0 0 0;"><strong>Location:</strong> ${loc}</p>
                </div>
            </div>
        `;
        
        document.getElementById('print-header').innerHTML = headerHtml;
        window.print();
    }

    // --- ATOMIC WEIGHTS DATA ---
    const ATOMIC_WEIGHTS = {
        H: 1.008, He: 4.003, Li: 6.94, Be: 9.012, B: 10.81, C: 12.011, N: 14.007, O: 15.999, F: 18.998, Ne: 20.180,
        Na: 22.990, Mg: 24.305, Al: 26.982, Si: 28.085, P: 30.974, S: 32.06, Cl: 35.45, K: 39.098, Ar: 39.948,
        Ca: 40.078, Sc: 44.956, Ti: 47.867, V: 50.942, Cr: 51.996, Mn: 54.938, Fe: 55.845, Co: 58.933, Ni: 58.693,
        Cu: 63.546, Zn: 65.38, Ga: 69.723, Ge: 72.63, As: 74.922, Se: 78.96, Br: 79.904, Kr: 83.798, Rb: 85.468,
        Sr: 87.62, Y: 88.906, Zr: 91.224, Nb: 92.906, Mo: 95.95, Tc: 98, Ru: 101.07, Rh: 102.91, Pd: 106.42,
        Ag: 107.87, Cd: 112.41, In: 114.82, Sn: 118.71, Sb: 121.76, Te: 127.60, I: 126.90, Xe: 131.29, Cs: 132.91,
        Ba: 137.33, La: 138.91, Ce: 140.12, Pr: 140.91, Nd: 144.24, Pm: 145, Sm: 150.36, Eu: 151.96, Gd: 157.25,
        Tb: 158.93, Dy: 162.50, Ho: 164.93, Er: 167.26, Tm: 168.93, Yb: 173.05, Lu: 174.97, Hf: 178.49, Ta: 180.95,
        W: 183.84, Re: 186.21, Os: 190.23, Ir: 192.22, Pt: 195.08, Au: 196.97, Hg: 200.59, Tl: 204.38, Pb: 207.2,
        Bi: 208.98, Th: 232.04, Pa: 231.04, U: 238.03
    };

    // --- FORMULA PARSING LOGIC ---
    function parseFormula(formula) {
        if (!formula) return null;
        formula = formula.trim();
        
        let result = { weight: 0, elements: {} };
        const parts = formula.split('.');
        
        const addElements = (elMap, multiplier) => {
            for (const [el, count] of Object.entries(elMap)) {
                result.elements[el] = (result.elements[el] || 0) + (count * multiplier);
                result.weight += (ATOMIC_WEIGHTS[el] || 0) * count * multiplier;
            }
        };

        parts.forEach((part, index) => {
            part = part.trim();
            if(!part) return;
            let multiplier = 1;
            const match = part.match(/^(\d+)(.*)/);
            if (match && index > 0) {
                 multiplier = parseInt(match[1]);
                 part = match[2];
            }
            const parsedPart = parseSimpleFormula(part);
            addElements(parsedPart, multiplier);
        });

        return result;
    }

    function parseSimpleFormula(str) {
        const elMap = {};
        let i = 0;
        
        const parseGroup = () => {
            const currentMap = {};
            while (i < str.length) {
                const char = str[i];
                if (char === '(') {
                    i++;
                    const innerMap = parseGroup();
                    if (str[i] === ')') {
                        i++;
                        let numStr = "";
                        while (i < str.length && /[0-9]/.test(str[i])) { numStr += str[i]; i++; }
                        const mult = numStr ? parseInt(numStr) : 1;
                        for(let el in innerMap) { currentMap[el] = (currentMap[el] || 0) + (innerMap[el] * mult); }
                    }
                } else if (char === ')') {
                    return currentMap;
                } else if (/[A-Z]/.test(char)) {
                    let el = char;
                    i++;
                    if (i < str.length && /[a-z]/.test(str[i])) { el += str[i]; i++; }
                    let numStr = "";
                    while (i < str.length && /[0-9]/.test(str[i])) { numStr += str[i]; i++; }
                    const count = numStr ? parseInt(numStr) : 1;
                    currentMap[el] = (currentMap[el] || 0) + count;
                } else { i++; }
            }
            return currentMap;
        };
        return parseGroup();
    }

    // --- APP STATE ---
    let sourceData = { elements: {} };
    let targetData = { elements: {} };

    function handleFormulaInput(type) {
        const inputId = type === 'source' ? 'sourceFormula' : 'targetFormula';
        const mwId = type === 'source' ? 'sourceMW' : 'targetMW';
        const formula = document.getElementById(inputId).value;
        const parsed = parseFormula(formula);
        
        if (parsed && parsed.weight > 0) {
            document.getElementById(mwId).value = parsed.weight.toFixed(4);
            if (type === 'source') sourceData = parsed;
            if (type === 'target') targetData = parsed;
            if (sourceData.weight > 0 && targetData.weight > 0) {
                calculateStoichiometry();
            }
        }
    }

    function calculateStoichiometry() {
        let ratio = null;
        let isConsistent = true;
        for (const [el, targetCount] of Object.entries(targetData.elements)) {
            const sourceCount = sourceData.elements[el] || 0;
            if (sourceCount === 0) { isConsistent = false; break; }
            const currentRatio = sourceCount / targetCount;
            if (ratio === null) { ratio = currentRatio; } 
            else if (Math.abs(ratio - currentRatio) > 0.01) { isConsistent = false; }
        }
        if (isConsistent && ratio !== null) {
            document.getElementById('stoich').value = Math.round(ratio);
        }
    }

    // --- CHART & INIT ---
    const initialData = [
        { x: 0.5, y: 0.045 },
        { x: 1.0, y: 0.092 },
        { x: 2.0, y: 0.188 },
        { x: 5.0, y: 0.465 },
        { x: 10.0, y: 0.940 }
    ];

    let chartInstance = null;

    window.onload = function() {
        initialData.forEach(pt => addRow(pt.x, pt.y));
    }

    function switchTab(tabId) {
        // Hide all contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        // Deactivate all buttons
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        // Show target content
        document.getElementById(tabId).classList.add('active');
        
        // Activate target button
        // Find index: 0=prep, 1=calib, 2=valid
        const btns = document.querySelectorAll('.nav-btn');
        if(tabId === 'prep') btns[0].classList.add('active');
        else if(tabId === 'calib') btns[1].classList.add('active');
        else if(tabId === 'valid') btns[2].classList.add('active');
    }

    // --- SOLUTION PREP LOGIC ---
    function calculateWeight() {
        const conc = parseFloat(document.getElementById('conc').value);
        const vol = parseFloat(document.getElementById('vol').value);
        const purity = parseFloat(document.getElementById('purity').value) || 100;
        const sourceMW = parseFloat(document.getElementById('sourceMW').value);
        const targetMW = parseFloat(document.getElementById('targetMW').value);
        const stoich = parseFloat(document.getElementById('stoich').value) || 1;

        if (isNaN(conc) || isNaN(vol)) {
            alert("Please enter valid numbers for Concentration and Volume.");
            return;
        }

        let factor = 1;
        let factorText = "";
        if (!isNaN(sourceMW) && !isNaN(targetMW) && targetMW > 0) {
            factor = sourceMW / (targetMW * stoich);
            factorText = ` √ó [${sourceMW} / (${targetMW} √ó ${stoich})]`;
        }

        const volL = vol / 1000;
        const mgTarget = conc * volL;
        const mgSourcePure = mgTarget * factor;
        const mgSourceActual = mgSourcePure / (purity / 100);
        const gActual = mgSourceActual / 1000;

        document.getElementById('prep-results').style.display = 'block';
        document.getElementById('mass-display').textContent = gActual.toFixed(5) + " g";
        document.getElementById('mass-mg-display').textContent = `(${mgSourceActual.toFixed(2)} mg)`;
        document.getElementById('calc-explanation').textContent = `Mass = (Conc √ó Vol${factorText}) / (Purity/100)`;
    }

    // --- CALIBRATION LOGIC ---
    function addRow(x = '', y = '') {
        const tbody = document.getElementById('calib-body');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="number" step="any" class="x-input" value="${x}"></td>
            <td><input type="number" step="any" class="y-input" value="${y}"></td>
            <td><button class="btn-danger" style="padding:4px 8px; border-radius:4px; border:none; cursor:pointer;" onclick="removeRow(this)">√ó</button></td>
        `;
        tbody.appendChild(row);
    }

    function removeRow(btn) { btn.closest('tr').remove(); }

    function getDataFromTable() {
        const xs = document.querySelectorAll('.x-input');
        const ys = document.querySelectorAll('.y-input');
        let data = [];
        xs.forEach((xEl, i) => {
            const x = parseFloat(xEl.value);
            const y = parseFloat(ys[i].value);
            if (!isNaN(x) && !isNaN(y)) { data.push({ x, y }); }
        });
        return data.sort((a, b) => a.x - b.x);
    }

    function processCalibration() {
        const data = getDataFromTable();
        if (data.length < 3) { alert("Please enter at least 3 valid data points."); return; }

        const n = data.length;
        const sumX = data.reduce((acc, pt) => acc + pt.x, 0);
        const sumY = data.reduce((acc, pt) => acc + pt.y, 0);
        const sumXY = data.reduce((acc, pt) => acc + (pt.x * pt.y), 0);
        const sumXX = data.reduce((acc, pt) => acc + (pt.x * pt.x), 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        const ssTot = data.reduce((acc, pt) => acc + Math.pow(pt.y - (sumY/n), 2), 0);
        const ssRes = data.reduce((acc, pt) => acc + Math.pow(pt.y - (slope * pt.x + intercept), 2), 0);
        const r2 = 1 - (ssRes / ssTot);
        const syx = Math.sqrt(ssRes / (n - 2));

        let lodDisplay = "Low R¬≤", loqDisplay = "Low R¬≤";
        if (r2 >= 0.9) {
            lodDisplay = ((3.3 * syx) / Math.abs(slope)).toFixed(3);
            loqDisplay = ((10 * syx) / Math.abs(slope)).toFixed(3);
        }

        document.getElementById('slope').textContent = slope.toFixed(4);
        document.getElementById('intercept').textContent = intercept.toFixed(4);
        document.getElementById('r2').textContent = r2.toFixed(4);
        document.getElementById('syx').textContent = syx.toFixed(4);
        document.getElementById('lod').textContent = lodDisplay;
        document.getElementById('loq').textContent = loqDisplay;

        updateChart(data, slope, intercept);
    }

    function updateChart(data, slope, intercept) {
        const ctx = document.getElementById('calibChart').getContext('2d');
        const minX = data[0].x;
        const maxX = data[data.length - 1].x;
        
        if (chartInstance) { chartInstance.destroy(); }
        chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Observed Data', data: data, backgroundColor: '#0ea5e9', pointRadius: 6, pointHoverRadius: 8
                }, {
                    label: `Linear Fit`, data: [{ x: minX, y: slope * minX + intercept }, { x: maxX, y: slope * maxX + intercept }],
                    type: 'line', borderColor: '#ef4444', borderWidth: 2, pointRadius: 0, fill: false
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Concentration' } },
                    y: { title: { display: true, text: 'Response' } }
                },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }
    
    // --- VALIDATION (RSD & RECOVERY) LOGIC ---
    function calculateRSD() {
        const raw = document.getElementById('rsdData').value;
        // Split by newlines, commas, or spaces
        const values = raw.split(/[\n, ]+/).filter(v => v.trim() !== "").map(Number).filter(n => !isNaN(n));
        
        if (values.length < 2) {
            alert("Please enter at least 2 values to calculate RSD.");
            return;
        }
        
        const n = values.length;
        const mean = values.reduce((a, b) => a + b, 0) / n;
        
        // Calculate Standard Deviation (Sample)
        const variance = values.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / (n - 1);
        const sd = Math.sqrt(variance);
        
        const rsd = (sd / mean) * 100;
        
        document.getElementById('rsd-n').textContent = n;
        document.getElementById('rsd-mean').textContent = mean.toFixed(4);
        document.getElementById('rsd-sd').textContent = sd.toFixed(4);
        document.getElementById('rsd-val').textContent = rsd.toFixed(2) + "%";
    }
    
    function calculateRecovery() {
        const unspiked = parseFloat(document.getElementById('concUnspiked').value);
        const spiked = parseFloat(document.getElementById('concSpiked').value);
        const added = parseFloat(document.getElementById('concAdded').value);
        
        if (isNaN(unspiked) || isNaN(spiked) || isNaN(added) || added === 0) {
            alert("Please enter valid numbers. 'Added Conc' cannot be zero.");
            return;
        }
        
        const recovery = ((spiked - unspiked) / added) * 100;
        
        document.getElementById('rec-results').style.display = 'block';
        document.getElementById('rec-display').textContent = recovery.toFixed(2) + "%";
        
        const disp = document.getElementById('rec-display');
        // Visual feedback for reasonable recovery range (80-120%)
        if (recovery >= 80 && recovery <= 120) {
            disp.style.color = 'var(--success)';
        } else {
            disp.style.color = 'var(--danger)';
        }
    }
</script>
</body>
</html>

